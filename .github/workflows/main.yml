name: CI/CD MLflow

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

env:
  CONDA_ENV_NAME: mlflow-env # Nama Environment dari conda.yaml
  CONDA_ENV_PATH: MLproject/conda.yaml
  DOCKER_IMAGE_NAME: cc 

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
      # 1. Checkout Kode
      - name: Checks out repository
        uses: actions/checkout@v4

      # 2. Setup Conda dan Install Dependencies
      - name: Set up Conda & Install Dependencies
        uses: conda-incubator/setup-miniconda@v3
        with:
          auto-update-conda: true
          python-version: '3.12.7' 
          activate-environment: ${{ env.CONDA_ENV_NAME }} 
          environment-file: ${{ env.CONDA_ENV_PATH }}
          auto-activate-base: false

      # 3. Run MLflow Project
      - name: Run MLflow Project
        run: |
          conda run -n ${{ env.CONDA_ENV_NAME }} mlflow run MLproject

      # 4. Get Latest MLflow Run ID (PERBAIKAN SINTAKSIS: menggunakan 'runs search')
      - name: Get latest MLflow run_id
        id: get_run_id
        run: |
          # Menggunakan mlflow runs search dan attributes.start_time
          RUN_ID=$(conda run -n ${{ env.CONDA_ENV_NAME }} mlflow runs search \
            --order-by attributes.start_time DESC \
            --max-results 1 \
            --output-json | jq -r '.[0].info.run_id')
          
          if [ -z "$RUN_ID" ]; then
            echo "ERROR: RUN_ID tidak ditemukan. Pastikan MLflow Run berhasil di step 3."
            exit 1
          fi
          
          echo "RUN_ID=$RUN_ID" >> $GITHUB_ENV
          echo "Latest run_id: $RUN_ID"

      # 5. Build Docker Model
      - name: Build Docker Model
        run: |
          conda run -n ${{ env.CONDA_ENV_NAME }} mlflow models build-docker \
            --model-uri "runs:/$RUN_ID/model" \
            --name ${{ env.DOCKER_IMAGE_NAME }}
            
      # --- Deployment Steps ---
      
      # 6. Login to Docker Hub
      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_HUB_USERNAME }}
          password: ${{ secrets.DOCKER_HUB_ACCESS_TOKEN }}
          
      # 7. Tag Docker Image
      - name: Tag Docker Image
        run: |
          docker tag ${{ env.DOCKER_IMAGE_NAME }} ${{ secrets.DOCKER_HUB_USERNAME }}/${{ env.DOCKER_IMAGE_NAME }}:latest
          
      # 8. Push Docker Image ke Docker Hub
      - name: Push Docker Image
        run: |
          docker push ${{ secrets.DOCKER_HUB_USERNAME }}/${{ env.DOCKER_IMAGE_NAME }}:latest
